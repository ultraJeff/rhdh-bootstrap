# RHDH Application Configuration - contains Backstage app-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  annotations:
    rhdh.redhat.com/backstage-name: developer-hub
    argocd.argoproj.io/sync-wave: "2"
  labels:
    rhdh.redhat.com/ext-config-sync: "true"
  name: app-config-rhdh
  namespace: rhdh
data:
  app-config-rhdh.yaml: |
    app:
      title: Red Hat Developer Hub
      baseUrl: ${BACKEND_URL}
    argocd:
      appLocatorMethods:
        - type: config
          instances:
            - name: argocd
              url: ${ARGOCD_URL}
              username: ${ARGOCD_USERNAME}
              password: ${ARGOCD_PASSWORD}
    signInPage: oidc
    auth:
      session:
        secret: ${BACKEND_SECRET}
      environment: production
      providers:
        guest:
          dangerouslyAllowOutsideDevelopment: true
        oidc:
          production:
            metadataUrl: ${KEYCLOAK_BASE_URL}/realms/${KEYCLOAK_REALM}/.well-known/openid-configuration
            clientId: ${KEYCLOAK_CLIENT_ID}
            clientSecret: ${KEYCLOAK_CLIENT_SECRET}
            prompt: auto
        github:
          production:
            clientId: ${GITHUB_INTEGRATION_CLIENT_ID}
            clientSecret: ${GITHUB_INTEGRATION_CLIENT_SECRET}
            disableIdentityResolution: true
      externalAccess:
      - options:
          subject: orchestrator
          token: ${BACKEND_SECRET}
        type: static
    backend:
      auth:
        externalAccess:
          - type: static
            options:
              token: ${BACKEND_SECRET}
              subject: external-access
      cors:
        origin: ${BACKEND_URL}
      baseUrl: ${BACKEND_URL}
      reading:
        allow:
          - host: raw.githubusercontent.com
          - host: dev.azure.com
    catalog:
      locations:
        - type: url
          target: https://raw.githubusercontent.com/redhat-appstudio/tssc-sample-templates/release-v1.8.x/all.yaml
        # Azure DevOps test app
        - type: url
          target: ${AZURE_DEVOPS_CATALOG_URL}
        # Azure DevOps Node.js template (from this repo)
        - type: url
          target: https://github.com/ultraJeff/rhdh-ado-bootstrap/blob/main/templates/azure-devops-nodejs-app/template.yaml
        # Utilities microservices (GitHub ultraJeff)
        - type: url
          target: https://github.com/ultraJeff/utilities-gateway/blob/main/catalog-info.yaml
        - type: url
          target: https://github.com/ultraJeff/utilities-weather/blob/main/catalog-info.yaml
        - type: url
          target: https://github.com/ultraJeff/utilities-quotes/blob/main/catalog-info.yaml
      providers:
        keycloakOrg:
          default:
            baseUrl: ${KEYCLOAK_BASE_URL}
            loginRealm: ${KEYCLOAK_REALM}
            realm: ${KEYCLOAK_REALM}
            clientId: ${KEYCLOAK_CLIENT_ID}
            clientSecret: ${KEYCLOAK_CLIENT_SECRET}
            schedule:
              frequency:
                minutes: 5
              timeout:
                minutes: 3
              initialDelay:
                seconds: 15
        github:
          providerId:
            organization: "${GITHUB_INTEGRATION_ORGANIZATION}"
            schedule:
              frequency:
                minutes: 30
              initialDelay:
                seconds: 15
              timeout:
                minutes: 15
        githubOrg:
          id: ultraJeffOrg
          githubUrl: "https://github.com"
          orgs:
            - ${GITHUB_INTEGRATION_ORGANIZATION}
          schedule:
            frequency:
              minutes: 30
            initialDelay:
              seconds: 15
            timeout:
              minutes: 15
        # GitHub discovery for ultraJeff repos with catalog-info.yaml
        githubDiscovery:
          ultraJeff:
            organization: ultraJeff
            catalogPath: /catalog-info.yaml
            schedule:
              frequency:
                minutes: 10
              initialDelay:
                seconds: 30
              timeout:
                minutes: 3
        # Note: Azure DevOps catalog provider requires backstage-plugin-catalog-backend-module-azure
        # which is not available as a dynamic plugin in RHDH 1.8. Use catalog locations instead.
        # azureDevOps:
        #   yourProviderId:
        #     organization: ${AZURE_DEVOPS_ORG}
        #     project: '*'
        #     repository: '*'
        #     path: /catalog-info.yaml
        #     schedule:
        #       frequency:
        #         minutes: 30
        #       timeout:
        #         minutes: 3
        # Microsoft Graph provider - imports users/groups from Entra ID
        # Disabled until Azure credentials are configured
        # microsoftGraphOrg:
        #   default:
        #     clientId: ${AZURE_CLIENT_ID}
        #     clientSecret: ${AZURE_CLIENT_SECRET}
        #     tenantId: ${AZURE_TENANT_ID}
        #     schedule:
        #       frequency:
        #         minutes: 30
        #       timeout:
        #         minutes: 10
        #       initialDelay:
        #         seconds: 15
    proxy:
      endpoints:
        /azure-devops:
          target: https://dev.azure.com
          headers:
            Authorization: Basic ${AZURE_TOKEN_BASE64}
            content-type: 'application/json'
          changeOrigin: true
          logLevel: debug
    integrations:
      github:
        # GitHub access with PAT to avoid rate limiting
        - host: github.com
          token: ${GITHUB_TOKEN}
        # GitHub App integration for org repos
        - host: ${GITHUB_INTEGRATION_HOST_DOMAIN}
          apps:
            - appId: ${GITHUB_INTEGRATION_APP_ID}
              clientId: ${GITHUB_INTEGRATION_CLIENT_ID}
              clientSecret: ${GITHUB_INTEGRATION_CLIENT_SECRET}
              privateKey: |
                ${GITHUB_INTEGRATION_PRIVATE_KEY_FILE}
      azure:
        - host: dev.azure.com
          credentials:
            # Use Personal Access Token for Azure DevOps - simpler than OAuth
            - personalAccessToken: ${AZURE_TOKEN}
    kubernetes:
      serviceLocatorMethod:
        type: multiTenant
      clusterLocatorMethods:
        - type: config
          clusters:
            - name: local
              url: https://kubernetes.default.svc
              authProvider: serviceAccount
              skipTLSVerify: true
              skipMetricsLookup: true
    devSpaces:
      defaultNamespace: <username>-devspaces
    extensions:
      installation:
        enabled: true
    permission:
      enabled: true
      rbac:
        policies-csv-file: /opt/app-root/src/rbac-policies.csv
        admin:
          users:
            - name: user:default/admin
